---
import SocialIcons from "./SocialIcons.astro";
import { Image } from "astro:assets";
import { YouTube } from "@astro-community/astro-embed-youtube";

interface Props {
  title: string;
  album: string;
  releaseDate?: string;
  cover?: string;
  links?: Record<string, string>;
  latest?: boolean;
}
const {
  title,
  cover,
  links = {},
  album,
  latest,
}: Props = Astro.props;

/** Extrae un ID válido de YouTube (watch, youtu.be, shorts, embed, music) y limpia params extra */
function getYouTubeId(url?: string | null): string | null {
  if (!url) return null;
  try {
    // quita parámetros “si” u otros trackers
    const clean = url.replace(/(\?|\&)si=[^&]+/g, "");
    const u = new URL(clean);
    const host = u.hostname.replace(/^m\./, ""); // m.youtube.com -> youtube.com

    if (host.includes("youtu.be")) {
      // https://youtu.be/VIDEOID
      return u.pathname.slice(1) || null;
    }
    if (host.includes("youtube.com") || host.includes("music.youtube.com")) {
      if (u.pathname === "/watch") return u.searchParams.get("v");
      if (u.pathname.startsWith("/shorts/"))
        return u.pathname.split("/")[2] || null;
      if (u.pathname.startsWith("/embed/"))
        return u.pathname.split("/")[2] || null;
    }
    return null;
  } catch {
    return null;
  }
}

const youTubeId = getYouTubeId(links.youtube);
const showVideo = Boolean(latest && youTubeId);

---

<div
  class="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 hover:border-white/20 transition-all duration-300 hover:bg-white/10 hover:shadow-xl overflow-hidden"
>
  {
    showVideo && youTubeId ? (
      /* Video responsive 16:9 */
      <div class="w-full">
        <YouTube id={youTubeId} />
        <div class="flex items-center justify-between gap-4 p-3">
          <div class="flex-1">
            <h3 class="text-foreground font-medium text-left">{title}</h3>
            <p class="text-foreground/60 text-sm text-left capitalize">
              {album}
            </p>
          </div>

          {/* Botón por si el embed está restringido en mobile */}
          {links.youtube && (
            <a
              href={links.youtube}
              target="_blank"
              rel="noopener noreferrer"
              class="text-xs px-2 py-1 rounded bg-muted text-muted-foreground hover:text-foreground"
            >
              Abrir en YouTube
            </a>
          )}
        </div>
      </div>
    ) : (
      /* Cover por defecto */
      <div class="flex items-start gap-4 p-4">
        <div class="relative group">
          {cover && (
            <>
              <Image
                src={cover}
                alt={title}
                class="size-16 rounded-xl object-cover shadow-lg"
                loading="lazy"
                decoding="async"
                width={64}
                height={64}
              />
              <div class="absolute inset-0 bg-black/20 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-200" />
            </>
          )}
        </div>
        <div class="flex-1 text-left">
          <h3 class="text-foreground font-semibold text-lg mb-1">{title}</h3>
          <p class="text-foreground/70 text-sm mb-3">{album}</p>
          <div class="flex items-center gap-2">
            <SocialIcons links={links} size={30} section="release" />
          </div>
        </div>
      </div>
    )
  }
</div>
