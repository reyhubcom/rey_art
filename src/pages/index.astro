---
import site from "../data/site.json";
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import UpcomingShows from "../components/UpcomingShows.astro";
import ReleasesList from "../components/ReleasesList.astro";
import ExternalLinks from "../components/ExternalLinks.astro";
import Booking from "../components/Booking.astro";
import Footer from "../components/Footer.astro";
import type { Theme, FontPreset } from "../types/theme";
import { isTheme } from "../types/theme";
import { isValidShow, isValidRelease, hasBooking, isValidLink } from "../utils/guards";

// theme & font seguros
const font: FontPreset = (site?.config?.font as FontPreset) ?? "modern";
const theme: Theme = isTheme(site?.config?.theme) ? site.config.theme : "dark";
const artist = site?.artist ?? {};

// normalizo y filtro datos
const allShows = Array.isArray(site?.shows)
  ? site.shows.filter(isValidShow)
  : [];
const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
const upcomingShows = allShows.filter((s) => s.date >= today);

const releases = Array.isArray(site?.releases)
  ? site.releases
      .filter(isValidRelease)
      .sort((a, b) => b.releaseDate.localeCompare(a.releaseDate))
  : [];

const allLinks = Array.isArray(site?.links)
  ? site.links.filter(isValidLink)
  : [];

const showUpcoming = upcomingShows.length > 0;
const showReleases = releases.length > 0;
const showBooking = hasBooking(site?.booking);
const showLinks = allLinks.length > 0;

---

<Layout
  theme={theme}
  title={site.config.title}
  description={site.config.description}
  font={font}
>
  <div class="relative z-10 max-w-xl mx-auto px-2 py-8 space-y-6">
    <Header {...artist} links={site?.socials ?? {}} />

    {showUpcoming && <UpcomingShows shows={upcomingShows} />}

    {showReleases && <ReleasesList releases={releases} />}

    {showLinks && <ExternalLinks links={site?.links ?? []} />}

    {showBooking && <Booking {...site.booking} />}

    <Footer copyright={site?.config?.copyright} />
  </div>
</Layout>
